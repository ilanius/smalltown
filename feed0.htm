<!doctype html>
<html id="docuTop">
<head>
  <?php 
    requir0('head', $R);
    $pr = $R['profile'];
    global $C;
  ?>

  <script>
    "strict";
    var profileId      = "<?=$R['profileId']?>";
    var uId            = "<?=$R['uId']?>";
    var uImageId       = "<?=$R['user']['uImageId']?>";
    var profileImage   = '<?=$R['profile']['uImageId']?>';
    feedType           = '<?=$R['feedType']?>'; /* declared in script.js global */
    var lastFeedTime   = 0;   // server clock
    var feedUpdateTime = 0;   // client timer
    var feedClearInterval = parseInt('<?=$C->feedClearInterval/2 ?>');
    var feedPosition   = 0;
    var maxScrollY     = window.scrollY;
    var cTimeOut       = 0;

    function buildTree( tree ) {
        let str = '';
        for ( var i in tree ) {
            var p = tree[i];
            str += postCreate( p, buildTree( p['child'] )  );
        }
        return str;
    }  
    function userFeedAdd( txt ) {  // supplements post tree
        var tree = JSON.parse( txt );
        if ( tree.length > 0 ) feedPosition+= 100; 
        var contPane = gid( 'pId' );
        contPane.innerHTML += buildTree( tree );  
    }
    function userFeed() {
        var sendTxt = `func=${feedType}&profileId=${profileId}&feedPosition=${feedPosition}`;
        httpPost( sendTxt, userFeedAdd );
    }
    
    /* this function may be called inside call interval */
    function feedUpdate() { 
        clearTimeout( feedUpdateTime ); 
        var sendTxt = `func=feedUpdate&feedType=${feedType}&lastFeedTime=${lastFeedTime}`;
        httpPost( sendTxt, feedUpdateSet );
        feedUpdateTime = setTimeout( feedUpdate , 5000 );
    }
  </script>
</head>

<body class="feed">
  
  <?php requir0( 'headPane', $R ); ?>
  
  <div class="profileBox">
    <img src="img/<?=$R['profile']['uImageId']?>" width="100"> 
    <span> <?php echo $pr['uFirstName']. ' '. $pr['uLastName']; ?> </span>
      <?php 
      if ( $R['uId'] != $R['profileId'] ) {
        echo '<span id="row_'.$R['profileId'].'" class="relationBox">';
        echo expressRelation( $R, $R['profile']);
        echo "</span>";
      }
      ?>
      <br>
    <input type="text" id="commentInput" name="commentInput" 
           class="comment" placeholder="What is on your mind" 
           onkeyup="postSubmit(event,this);" >
  </div>
  
  <div id="pId" class="contPane"> <!-- pId is used by script -->
  
  </div>

  <div class="footPane"> 
  -- empty foot pane
  <button onclick="feedUpdate()">feedUpdate</button>
  </div>

  <script>   
    /* **************************************************************** */
    /* When user has a long feed it is not convenient to load everything.
    It would waste server resources (bandwidth,cpu) and if the feed is too long
    neither server nor browser could handle the load. Instead we deliver parts
    of the feed on request. When the user scrolls down we try to catch
    up and fill the feed */
    /* **************************************************************** */
    document.addEventListener( 'scroll', 
      function(e) {
        if ( window.scrollY > maxScrollY ) {
          /* scroll fires a lot. These two lines works as a brake */
          clearTimeout( cTimeOut );
          cTimeOut = setTimeout( userFeed , feedClearInterval ); 
          /* **************************************************** */   
          maxScrollY = window.scrollY;
       }
      } 
    );
    userFeed(); // first load
  </script>
</body>
</html>
